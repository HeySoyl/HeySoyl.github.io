<!DOCTYPE html><html lang="[&quot;zh-Hans&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Percona Tookit学习手册 - pt-query-digest"><meta name="keywords" content="Tookit"><meta name="author" content="Soyl"><meta name="copyright" content="Soyl"><title>Percona Tookit学习手册 - pt-query-digest | Soyl's Blog</title><link rel="shortcut icon" href="/Icon.png"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.9.0/css/all.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="manifest" href="/manifest.json"><link rel="manifest" href="/manifest.json"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-5485968112876534',
  enable_page_level_ads: 'true'
});
</script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?aa8f97cc0791747be9d3abce013ed1c7";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', '132783894', 'auto');
ga('send', 'pageview');</script><link rel="dns-prefetch" href="http://ta.qq.com"><script>(function() {
   var hm = document.createElement("script");
   hm.src = "https://tajs.qq.com/stats?sId=66455759";
   var s = document.getElementsByTagName("script")[0];
   s.parentNode.insertBefore(hm, s);
 })();</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#pt-query-digest介绍"><span class="toc-number">1.</span> <span class="toc-text">pt-query-digest介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#慢查询日志开启方法"><span class="toc-number">1.1.</span> <span class="toc-text">慢查询日志开启方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pt-query-digest语法"><span class="toc-number">1.2.</span> <span class="toc-text">pt-query-digest语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pt-query-digest使用方法"><span class="toc-number">1.3.</span> <span class="toc-text">pt-query-digest使用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#直接使用"><span class="toc-number">1.3.1.</span> <span class="toc-text">直接使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#输出到数据库"><span class="toc-number">1.3.2.</span> <span class="toc-text">输出到数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分析最近12小时内的查询"><span class="toc-number">1.3.3.</span> <span class="toc-text">分析最近12小时内的查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分析指定时间范围内的查询"><span class="toc-number">1.3.4.</span> <span class="toc-text">分析指定时间范围内的查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分析指含有select语句的慢查询"><span class="toc-number">1.3.5.</span> <span class="toc-text">分析指含有select语句的慢查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#针对某个用户的慢查询"><span class="toc-number">1.3.6.</span> <span class="toc-text">针对某个用户的慢查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查询所有所有的全表扫描或full-join的慢查询"><span class="toc-number">1.3.7.</span> <span class="toc-text">查询所有所有的全表扫描或full join的慢查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#把查询保存到query-review表"><span class="toc-number">1.3.8.</span> <span class="toc-text">把查询保存到query_review表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#把查询保存到query-history表"><span class="toc-number">1.3.9.</span> <span class="toc-text">把查询保存到query_history表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#通过tcpdump抓取mysql的tcp协议数据，然后再分析"><span class="toc-number">1.3.10.</span> <span class="toc-text">通过tcpdump抓取mysql的tcp协议数据，然后再分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分析binlog"><span class="toc-number">1.3.11.</span> <span class="toc-text">分析binlog</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分析general-log"><span class="toc-number">1.3.12.</span> <span class="toc-text">分析general log</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分析结果详解"><span class="toc-number">1.4.</span> <span class="toc-text">分析结果详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#第一部分"><span class="toc-number">1.4.1.</span> <span class="toc-text">第一部分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第二部分"><span class="toc-number">1.4.2.</span> <span class="toc-text">第二部分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第三部分"><span class="toc-number">1.4.3.</span> <span class="toc-text">第三部分</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Soyl</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/HeySoyl" target="_blank" rel="noopener">Follow ME</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">40</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">19</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">21</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Soyl's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">主页</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a><a class="site-page" href="/archives">文章</a><a class="site-page" href="/about">我</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">Percona Tookit学习手册 - pt-query-digest</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-05-10</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/APP/">APP</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/APP/MySQL/">MySQL</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">2.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 10 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="pt-query-digest介绍"><a href="#pt-query-digest介绍" class="headerlink" title="pt-query-digest介绍"></a>pt-query-digest介绍</h2><a id="more"></a>
<p>pt-query-digest是用于分析mysql慢查询的一个工具，它可以分析binlog、General log、slowlog，也可以通过SHOWPROCESSLIST或者通过tcpdump抓取的MySQL协议数据来进行分析。可以把分析结果输出到文件中，分析过程是先对查询语句的条件进行参数化，然后对参数化以后的查询进行分组统计，统计出各查询的执行时间、次数、占比等，可以借助分析结果找出问题进行优化。</p>
<h3 id="慢查询日志开启方法"><a href="#慢查询日志开启方法" class="headerlink" title="慢查询日志开启方法"></a>慢查询日志开启方法</h3><p>在mysql的my.ini文件中的mysqld中添加下面参数，然后重启mysql。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">slow_query_log_file='/home/mysql/sql_log/mysql-slow.log'  //设置慢查询日志位置</span><br><span class="line">log_queries_not_using_indexes=on  //设置是否把没有使用索引的SQL放到慢查询日志中,off是没有开启,on是开始</span><br><span class="line">slow_query_log=on  //设置开启慢查询日志,off是没有开启,on是开始</span><br><span class="line">long_query_time=1  //查过多少秒的查询设置到慢查询日志中,单位是秒</span><br></pre></td></tr></table></figure>
<blockquote>
<p>long_query_time=1设置后，实际上mysql也会把一些小于1S的操作记录下来，主要是因为索引的影响，可以直接把额外的记录忽略。</p>
</blockquote>
<h3 id="pt-query-digest语法"><a href="#pt-query-digest语法" class="headerlink" title="pt-query-digest语法"></a>pt-query-digest语法</h3><blockquote>
<p>pt-query-digest [OPTIONS] [FILES] [DSN]</p>
</blockquote>
<p>–create-review-table  当使用–review参数把分析结果输出到表中时，如果没有表就自动创建。<br>–create-history-table  当使用–history参数把分析结果输出到表中时，如果没有表就自动创建。<br>–filter  对输入的慢查询按指定的字符串进行匹配过滤后再进行分析<br>–limit限制输出结果百分比或数量，默认值是20,即将最慢的20条语句输出，如果是50%则按总响应时间占比从大到小排序，输出到总和达到50%位置截止。<br>–host  MySQL服务器地址<br>–user  mysql用户名<br>–password  mysql用户密码<br>–history 将分析结果保存到表中，分析结果比较详细，下次再使用–history时，如果存在相同的语句，且查询所在的时间区间和历史表中的不同，则会记录到数据表中，可以通过查询同一CHECKSUM来比较某类型查询的历史变化。<br>–review 将分析结果保存到表中，这个分析只是对查询条件进行参数化，一个类型的查询一条记录，比较简单。当下次使用–review时，如果存在相同的语句分析，就不会记录到数据表中。<br>–output 分析结果输出类型，值可以是report(标准分析报告)、slowlog(Mysql slow log)、json、json-anon，一般使用report，以便于阅读。<br>–since 从什么时间开始分析，值为字符串，可以是指定的某个”yyyy-mm-dd [hh:mm:ss]”格式的时间点，也可以是简单的一个时间值：s(秒)、h(小时)、m(分钟)、d(天)，如12h就表示从12小时前开始统计。<br>–until 截止时间，配合—since可以分析一段时间内的慢查询，格式与since相同。</p>
<h3 id="pt-query-digest使用方法"><a href="#pt-query-digest使用方法" class="headerlink" title="pt-query-digest使用方法"></a>pt-query-digest使用方法</h3><h4 id="直接使用"><a href="#直接使用" class="headerlink" title="直接使用"></a>直接使用</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">pt-query-digest /usr/local/mysql/data/slow.log | more</span><br></pre></td></tr></table></figure>

<h4 id="输出到数据库"><a href="#输出到数据库" class="headerlink" title="输出到数据库"></a>输出到数据库</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">pt-query-digest slow.log -review \</span><br><span class="line">h=127.0.0.1,D=test,p=root,P=3306,u=root,t=query_review \</span><br><span class="line"><span class="comment">--create-reviewtable \</span></span><br><span class="line"><span class="comment">--review-history t= hostname_slow</span></span><br></pre></td></tr></table></figure>

<h4 id="分析最近12小时内的查询"><a href="#分析最近12小时内的查询" class="headerlink" title="分析最近12小时内的查询"></a>分析最近12小时内的查询</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">pt-query-digest  <span class="comment">--since=12h  slow.log &gt; slow_report2.log</span></span><br></pre></td></tr></table></figure>

<h4 id="分析指定时间范围内的查询"><a href="#分析指定时间范围内的查询" class="headerlink" title="分析指定时间范围内的查询"></a>分析指定时间范围内的查询</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">pt-query-digest slow.log <span class="comment">--since '2014-04-17 09:30:00' --until '2014-04-17 10:00:00'&gt; &gt; slow_report3.log</span></span><br></pre></td></tr></table></figure>

<h4 id="分析指含有select语句的慢查询"><a href="#分析指含有select语句的慢查询" class="headerlink" title="分析指含有select语句的慢查询"></a>分析指含有select语句的慢查询</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">pt-query-digest<span class="comment">--filter '$event-&gt;&#123;fingerprint&#125; =~ m/^select/i' slow.log&gt; slow_report4.log</span></span><br></pre></td></tr></table></figure>

<h4 id="针对某个用户的慢查询"><a href="#针对某个用户的慢查询" class="headerlink" title="针对某个用户的慢查询"></a>针对某个用户的慢查询</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">pt-query-digest<span class="comment">--filter '($event-&gt;&#123;user&#125; || "") =~ m/^root/i' slow.log&gt; slow_report5.log</span></span><br></pre></td></tr></table></figure>

<h4 id="查询所有所有的全表扫描或full-join的慢查询"><a href="#查询所有所有的全表扫描或full-join的慢查询" class="headerlink" title="查询所有所有的全表扫描或full join的慢查询"></a>查询所有所有的全表扫描或full join的慢查询</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">pt-query-digest<span class="comment">--filter '(($event-&gt;&#123;Full_scan&#125; || "") eq "yes") ||(($event-&gt;&#123;Full_join&#125; || "") eq "yes")' slow.log&gt; slow_report6.log</span></span><br></pre></td></tr></table></figure>

<h4 id="把查询保存到query-review表"><a href="#把查询保存到query-review表" class="headerlink" title="把查询保存到query_review表"></a>把查询保存到query_review表</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">pt-query-digest  <span class="comment">--user=root –password=abc123 --review  h=localhost,D=test,t=query_review--create-review-table  slow.log</span></span><br></pre></td></tr></table></figure>

<h4 id="把查询保存到query-history表"><a href="#把查询保存到query-history表" class="headerlink" title="把查询保存到query_history表"></a>把查询保存到query_history表</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">pt-query-digest  <span class="comment">--user=root –password=abc123 --review  h=localhost,D=test,t=query_history--create-review-table  slow.log_20140401</span></span><br><span class="line">pt-query-digest  <span class="comment">--user=root –password=abc123 --review  h=localhost,D=test,t=query_history--create-review-table  slow.log_20140402</span></span><br></pre></td></tr></table></figure>

<h4 id="通过tcpdump抓取mysql的tcp协议数据，然后再分析"><a href="#通过tcpdump抓取mysql的tcp协议数据，然后再分析" class="headerlink" title="通过tcpdump抓取mysql的tcp协议数据，然后再分析"></a>通过tcpdump抓取mysql的tcp协议数据，然后再分析</h4><p>pt-query-digest对于抓包有一定的格式。(-x -nn -q -tttt)</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">tcpdump -s 65535 -x -nn -q -tttt -i any -c 1000 port 3306 &gt; mysql.tcp.txt</span><br><span class="line">pt-query-digest <span class="comment">--type tcpdump mysql.tcp.txt&gt; slow_report9.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -s:源端口</span></span><br><span class="line"><span class="comment"># -c:抓包的数量</span></span><br></pre></td></tr></table></figure>

<h4 id="分析binlog"><a href="#分析binlog" class="headerlink" title="分析binlog"></a>分析binlog</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysqlbinlog mysql-bin.000093 &gt; mysql-bin000093.sql</span><br><span class="line">pt-query-digest  <span class="comment">--type=binlog  mysql-bin000093.sql &gt; slow_report10.log</span></span><br></pre></td></tr></table></figure>

<h4 id="分析general-log"><a href="#分析general-log" class="headerlink" title="分析general log"></a>分析general log</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">pt-query-digest  <span class="comment">--type=genlog  localhost.log &gt; slow_report11.log</span></span><br></pre></td></tr></table></figure>

<h3 id="分析结果详解"><a href="#分析结果详解" class="headerlink" title="分析结果详解"></a>分析结果详解</h3><h4 id="第一部分"><a href="#第一部分" class="headerlink" title="第一部分"></a>第一部分</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 18.4s user time, 90ms system time, 27.27M rss, 223.26M vsz</span></span><br><span class="line"><span class="comment"># Current date: Tue May 10 11:51:19 2016</span></span><br><span class="line"><span class="comment"># Hostname: mjjw</span></span><br><span class="line"><span class="comment"># Files: /usr/local/mysql/data/mjjw-slow.log</span></span><br><span class="line"><span class="comment"># Overall: 29.20k total, 25 unique, 0.41 QPS, 0.51x concurrency __________</span></span><br><span class="line"><span class="comment"># Time range: 2016-05-09 16:12:24 to 2016-05-10 11:51:19</span></span><br><span class="line"><span class="comment"># Attribute          total     min     max     avg     95%  stddev  median</span></span><br><span class="line"><span class="comment"># ============     ======= ======= ======= ======= ======= ======= =======</span></span><br><span class="line"><span class="comment"># Exec time         36179s   120us     27s      1s     10s      3s   541us</span></span><br><span class="line"><span class="comment"># Lock time            15s       0   454ms   501us   839us     4ms   194us</span></span><br><span class="line"><span class="comment"># Rows sent         98.30k       0    1000    3.45   19.46    8.51    0.99</span></span><br><span class="line"><span class="comment"># Rows examine       5.22G       0   1.48M 187.54k   1.46M 367.29k   28.75</span></span><br><span class="line"><span class="comment"># Query size        46.97M      36   4.46k   1.65k   3.52k   1.46k  363.48</span></span><br></pre></td></tr></table></figure>
<p>Overall: 总共有多少条查询<br>unique: 唯一查询数量，即对查询条件进行参数化以后，总共有多少个不同的查询，该例为25。<br>Time range: 查询执行的时间范围。<br>total: 总计   min:最小   max: 最大  avg:平均  95%: 把所有值从小到大排列，位置位于95%的那个数，这个数一般最具有参考价值。<br>median: 中位数，把所有值从小到大排列，位置位于中间那个数。</p>
<h4 id="第二部分"><a href="#第二部分" class="headerlink" title="第二部分"></a>第二部分</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Profile</span></span><br><span class="line"><span class="comment"># Rank Query ID           Response time    Calls R/Call  V/M   Item</span></span><br><span class="line"><span class="comment"># ==== ================== ================ ===== ======= ===== ===========</span></span><br><span class="line"><span class="comment">#    1 0x3C82B414C14E5C06 14439.8524 39.9%  3220  4.4844  9.20 SELECT STUDENT STUDENT_SCHOOL SCHOOL_TABLE STUDENT_ORGAN ORGAN ORDER_FORM T_?_USE</span></span><br><span class="line">R_INFO STUDENT_SELL T_?_USER_INFO STUDENT_CONTACT_PERSON LEA_COU_ONE STUDENT_ASSISTANT T_?_USER_INFO LCO_ALLOT_TEACHER T_?_USER_INFO USER_DEPART</span><br><span class="line">MENT DEPARTMENT COURSE</span><br><span class="line"><span class="comment">#    2 0xB86C64C70BAA831C 10486.1545 29.0%   951 11.0265  0.55 SELECT STUDENT STUDENT_SCHOOL SCHOOL_TABLE STUDENT_ORGAN ORGAN ORDER_FORM T_?_USE</span></span><br><span class="line">R_INFO STUDENT_SELL T_?_USER_INFO STUDENT_CONTACT_PERSON LEA_COU_ONE STUDENT_ASSISTANT T_?_USER_INFO LCO_ALLOT_TEACHER T_?_USER_INFO USER_DEPART</span><br><span class="line">MENT DEPARTMENT COURSE</span><br><span class="line"><span class="comment">#    3 0x3A8823AD8857EA9D  4635.8130 12.8%  3200  1.4487  1.33 SELECT STUDENT STUDENT_SCHOOL SCHOOL_TABLE STUDENT_ORGAN ORGAN ORDER_FORM T_?_USE</span></span><br><span class="line">R_INFO STUDENT_SELL T_?_USER_INFO STUDENT_CONTACT_PERSON LEA_COU_ONE STUDENT_ASSISTANT T_?_USER_INFO LCO_ALLOT_TEACHER T_?_USER_INFO USER_DEPART</span><br><span class="line">MENT DEPARTMENT COURSE</span><br><span class="line"><span class="comment">#    4 0x86AC36DBACB13484  4626.3197 12.8%  3200  1.4457  2.07 SELECT STUDENT STUDENT_SCHOOL SCHOOL_TABLE STUDENT_ORGAN ORGAN ORDER_FORM T_?_USE</span></span><br><span class="line">R_INFO STUDENT_SELL T_?_USER_INFO STUDENT_CONTACT_PERSON LEA_COU_ONE STUDENT_ASSISTANT T_?_USER_INFO LCO_ALLOT_TEACHER T_?_USER_INFO USER_DEPART</span><br><span class="line">MENT DEPARTMENT COURSE</span><br><span class="line"><span class="comment">#    5 0x0363FA1F2388C4D2  1527.4343  4.2%  2268  0.6735  0.29 SELECT STUDENT STUDENT_SCHOOL SCHOOL_TABLE STUDENT_ORGAN ORGAN ORDER_FORM T_?_USE</span></span><br><span class="line">R_INFO STUDENT_SELL T_?_USER_INFO STUDENT_CONTACT_PERSON LEA_COU_ONE STUDENT_ASSISTANT T_?_USER_INFO LCO_ALLOT_TEACHER T_?_USER_INFO USER_DEPART</span><br><span class="line">MENT DEPARTMENT COURSE</span><br><span class="line"><span class="comment"># MISC 0xMISC               463.5191  1.3% 16357  0.0283   0.0 &lt;20 ITEMS&gt;</span></span><br></pre></td></tr></table></figure>
<p>这部分对查询进行参数化并分组，然后对各类查询的执行情况进行分析，结果按总执行时长，从大到小排序。<br>Response: 总的响应时间。<br>time: 该查询在本次分析中总的时间占比。<br>calls: 执行次数，即本次分析总共有多少条这种类型的查询语句。<br>R/Call: 平均每次执行的响应时间。<br>Item : 查询对象</p>
<h4 id="第三部分"><a href="#第三部分" class="headerlink" title="第三部分"></a>第三部分</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Query 1: 1.04 QPS, 4.65x concurrency, ID 0x3C82B414C14E5C06 at byte 45899007</span></span><br><span class="line"><span class="comment"># Scores: V/M = 9.20</span></span><br><span class="line"><span class="comment"># Time range: 2016-05-10 10:59:36 to 11:51:19</span></span><br><span class="line"><span class="comment"># Attribute    pct   total     min     max     avg     95%  stddev  median</span></span><br><span class="line"><span class="comment"># ============ === ======= ======= ======= ======= ======= ======= =======</span></span><br><span class="line"><span class="comment"># Count         11    3220</span></span><br><span class="line"><span class="comment"># Exec time     39  14440s    89ms     27s      4s     17s      6s   816ms</span></span><br><span class="line"><span class="comment"># Lock time     15      2s   370us   165ms   688us   881us     3ms   467us</span></span><br><span class="line"><span class="comment"># Rows sent      3   3.14k       1       1       1       1       0       1</span></span><br><span class="line"><span class="comment"># Rows examine  36   1.91G 244.46k   1.48M 620.56k   1.46M 573.76k 233.54k</span></span><br><span class="line"><span class="comment"># Query size    17   8.38M   2.67k   2.67k   2.67k   2.67k       0   2.67k</span></span><br><span class="line"><span class="comment"># String:</span></span><br><span class="line"><span class="comment"># Hosts</span></span><br><span class="line"><span class="comment"># Users        admin</span></span><br><span class="line"><span class="comment"># Query_time distribution</span></span><br><span class="line"><span class="comment">#   1us</span></span><br><span class="line"><span class="comment">#  10us</span></span><br><span class="line"><span class="comment"># 100us</span></span><br><span class="line"><span class="comment">#   1ms</span></span><br><span class="line"><span class="comment">#  10ms  ##</span></span><br><span class="line"><span class="comment">#    1s  #############</span></span><br><span class="line"><span class="comment">#  10s+  #############################</span></span><br><span class="line"><span class="comment"># Tables</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `mysqlnew` LIKE 'STUDENT'\G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `mysqlnew`.`STUDENT`\G</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `mysqlnew` LIKE 'STUDENT_SCHOOL'\G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `mysqlnew`.`STUDENT_SCHOOL`\G</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `mysqlnew` LIKE 'SCHOOL_TABLE'\G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `mysqlnew`.`SCHOOL_TABLE`\G</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `mysqlnew` LIKE 'STUDENT_ORGAN'\G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `mysqlnew`.`STUDENT_ORGAN`\G</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `mysqlnew` LIKE 'ORGAN'\G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `mysqlnew`.`ORGAN`\G</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `mysqlnew` LIKE 'ORDER_FORM'\G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `mysqlnew`.`ORDER_FORM`\G</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `mysqlnew` LIKE 'T_0_USER_INFO'\G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `mysqlnew`.`T_0_USER_INFO`\G</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `mysqlnew` LIKE 'STUDENT_SELL'\G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `mysqlnew`.`STUDENT_SELL`\G</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `mysqlnew` LIKE 'STUDENT_CONTACT_PERSON'\G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `mysqlnew`.`STUDENT_CONTACT_PERSON`\G</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `mysqlnew` LIKE 'LEA_COU_ONE'\G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `mysqlnew`.`LEA_COU_ONE`\G</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `mysqlnew` LIKE 'STUDENT_ASSISTANT'\G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `mysqlnew`.`STUDENT_ASSISTANT`\G</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `mysqlnew` LIKE 'LCO_ALLOT_TEACHER'\G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `mysqlnew`.`LCO_ALLOT_TEACHER`\G</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `mysqlnew` LIKE 'USER_DEPARTMENT'\G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `mysqlnew`.`USER_DEPARTMENT`\G</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `mysqlnew` LIKE 'DEPARTMENT'\G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `mysqlnew`.`DEPARTMENT`\G</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `mysqlnew` LIKE 'COURSE'\G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `mysqlnew`.`COURSE`\G</span></span><br><span class="line"><span class="comment"># EXPLAIN /*!50100 PARTITIONS*/</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="number">1</span>)<span class="keyword">from</span>(<span class="keyword">SELECT</span> ATM_0.STUDENT_ID T_448_0,ATM_0.STU_NAME AFM_1,ATM_0.STU_SEX AFM_2,ATM_0.STU_SEX DIC_AFM_2,ATM_0.STU_PHONE AFM_3,ATM_0</span><br><span class="line">.STU_TYPE AFM_4,ATM_0.STU_TYPE DIC_AFM_4,ATM_0.EDUCATION AFM_5,ATM_0.EDUCATION DIC_AFM_5,ATM_0.ISVIP AFM_10,ATM_0.ISVIP DIC_AFM_10,ATM_0.STU_ABR</span><br><span class="line">OADTIME AFM_12,ATM_0.STU_ABROADTIME DIC_AFM_12,ATM_0.F_33345 AFM_13,ATM_0.SK_STYLE AFM_14,ATM_0.SK_STYLE DIC_AFM_14,ATM_0.CREATE_DATE AFM_16,ATM</span><br><span class="line">_0.IF_XY AFM_25,ATM_0.IF_XY DIC_AFM_25,ATM_0.STUDENT_ID LMF_ID,ATM_24_0.STU_ID RP_STU_ID_0,ATM_23_0.STU_ID RP_STU_ID_1,ATM_17_0.STU_ID RP_STU_ID</span><br><span class="line">_2,ATM_11_0.STU_ID RP_STU_ID_4,ATM_8_0.STU_ID RP_STU_ID_5,ATM_6_0.STU_ID RP_STU_ID_6 <span class="keyword">FROM</span> STUDENT ATM_0 <span class="keyword">INNER</span> <span class="keyword">JOIN</span>(<span class="keyword">SELECT</span> ATM_24_0.STU_ID <span class="keyword">FROM</span> S</span><br><span class="line">TUDENT_SCHOOL ATM_24_0 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> SCHOOL_TABLE ATM_24_1 <span class="keyword">ON</span> ATM_24_1.SCHOOL_TABLE_ID=ATM_24_0.SCH_ID <span class="keyword">WHERE</span> <span class="number">1</span>=<span class="number">1</span> <span class="keyword">AND</span>(ATM_24_1.SCHOOL_TABLE_ID <span class="keyword">IN</span>(<span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<p>这部分是每种查询的详细情况<br>最上面的表格列出了执行次数、最大、最小、平均、95%等各项目的统计。<br>Databases: 库名<br>Users: 各个用户执行的次数（占比）<br>Query_time distribution : 查询时间分布, 长短体现区间占比，本例中1s-10s之间查询数量是10s以上的两倍。<br>Tables: 查询中涉及到的表<br>Explain: 示例</p>
<blockquote>
<p>官方文档：<a href="http://www.percona.com/doc/percona-toolkit/2.2/pt-query-digest.html" target="_blank" rel="noopener">http://www.percona.com/doc/percona-toolkit/2.2/pt-query-digest.html</a></p>
</blockquote>
<blockquote>
<p>参考：<a href="http://blog.csdn.net/seteor/article/details/24017913" target="_blank" rel="noopener">http://blog.csdn.net/seteor/article/details/24017913</a></p>
</blockquote>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Soyl</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://soyl.tech/zh-cn/APP/MySQL/Percona_Tookit_pt-query-digest.html">https://soyl.tech/zh-cn/APP/MySQL/Percona_Tookit_pt-query-digest.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://soyl.tech">Soyl's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Tookit/">Tookit</a></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/zh-cn/APP/Loadrunner/Loadrunner_Error.html"><i class="fa fa-chevron-left">  </i><span>Loadrunner Error问题处理</span></a></div><div class="next-post pull-right"><a href="/zh-cn/APP/MongoDB/linux_mongodb.html"><span>Linux下安装MongoDB</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: 'd4eb80bd86a42e45541f',
  clientSecret: '54f001d38bbd5adde7b853a6d3ed08a47fd33172',
  repo: 'HeySoyl.github.io',
  owner: 'HeySoyl',
  admin: 'HeySoyl',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-Hans,en,default'
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2020 By Soyl</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.7" zIndex="-1" data-click="false"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"superSample":2,"width":210,"height":420,"position":"left","hOffset":0,"vOffset":-20},"log":false,"tagMode":false});</script></body></html>